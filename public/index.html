<!doctype hmtl>
<html>
	<head>
		<title>A react-js test</title>
		<link rel="stylesheet" type="text/css" href="./vendor/bootstrap/dist/css/bootstrap.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
	</head>
	<body>
		<h1>A react-js test</h1>
		<h3>A file upload with drag and drop test</h3>

		<div class="app" id="app"></div>
		
		<script src="./vendor/react/build/JSXTransformer.js"></script>
		<script src="./vendor/react/build/react.js"></script>
		
		<script type="text/jsx">
		/** @jsx React.DOM **/

		var FilterableTable = React.createClass({
			getInitialState: function () {
				return {
					filterText : ''
				};
			},
			handleFilterInput : function (filterText){
				this.setState({
					filterText : filterText
				});
			},
			render : function () {
				return (
					<section className="file-list">
						<FilterBar onFilterInput={this.handleFilterInput} filterText={this.state.filterText} />
						<FilesTable onDeleteFile={this.props.onDeleteFile} filterText={this.state.filterText} files={this.props.files} />
					</section>
				);
			}
		});

		var FilterBar = React.createClass({
			handleTextChange: function () {
				this.props.onFilterInput(this.refs.filterTextInput.getDOMNode().value);
			},
			render : function () {

				return (
					<div className="filter">
						<span>Search by name</span>
						<input ref="filterTextInput" value={this.props.filterText} onChange={this.handleTextChange} type="search" placeholder="Enter file name" />
					</div>
				);

			}
		});

		var FileRow = React.createClass({

			shouldComponentUpdate : function (nextProps, nextState) {
				return !(nextProps.name === this.props.name);
			},

			handleDelete : function () {

				this.props.onDeleteFile(this.props.file.name);

			},

			render : function () {

				return (
					<tr>
						<td>{this.props.file.name}</td>
						<td>{this.props.file.size}</td>
						<td>{this.props.file.type}</td>
						<td onClick={this.handleDelete}>
							<span className="glyphicon glyphicon-remove"></span>
						</td>
					</tr>
				)
			}
		});

		var FilesTable = React.createClass({

			render : function () {

				var props = this.props;

				var rows = this.props.files
				.filter(function (file){
					return file.name.toLowerCase().indexOf(props.filterText.toLowerCase()) > -1;
				})
				.map(function (file){
					return <FileRow onDeleteFile={props.onDeleteFile} key={file.name} file={file} />;
				});

				return (

					<table id="fileTable" className="table table-grid">
						<thead>
							<tr>
								<th>File name</th>
								<th>Size</th>
								<th>Type</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{rows}
						</tbody>
					</table>

				);
			}
		});

		var DropZone = React.createClass({

			handleDrop : function (e){

				e.preventDefault();

				this.className = '';

				var multipleFiles = Array.prototype.slice.call(e.dataTransfer.files);

				multipleFiles.map( function (file) {

					var dataFile = {
						name : file.name,
						size: file.size,
						type: file.type
					}

				});

				this.props.onNewFile(multipleFiles);

				return false;
			},

			handleDragOver : function () {

				this.className = 'hover';

				return false;
			},

			handleDragEnd : function () {

				this.className = '';

				return false;
			},

			render : function () {
				return (

					<section id="dragzone" onDragOver= {this.handleDragOver} onDragEnd={this.handleDragEnd} onDrop={this.handleDrop} className="drag-zone">
						<p>Drag your files here</p>
					</section>

				);
			}
		});

		var App = React.createClass({

			getInitialState : function () {

				return {
					files : []
				};
			},

			handleNewFile : function (file) {

				var newFiles = this.state.files.concat(file);

				this.setState({
					files : newFiles
				});
			},

			handleFileDelete : function (fileName) {

				var files = this.state.files.slice(0),
					newFiles = files.filter(function (file){
						return file.name !== fileName;
					});

				this.setState({
					files : newFiles
				});

			},

			render : function () { 

				return (

					<section>
						<DropZone onNewFile={this.handleNewFile} />
						<FilterableTable files={this.state.files} onDeleteFile={this.handleFileDelete} />
					</section>

				);
			}
		});

		React.renderComponent(<App />, document.getElementById('app'));
		</script>
	</body>
</html>